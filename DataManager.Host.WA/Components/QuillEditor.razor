@implements IAsyncDisposable
@inject IJSRuntime JS

<div @ref="editorElement" id="@EditorId" class="quill-editor-container"></div>

@code {
    [Parameter]
    public string EditorId { get; set; } = $"quill-{Guid.NewGuid():N}";

    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    [Parameter]
    public string? Placeholder { get; set; }

    [Parameter]
    public string Height { get; set; } = "200px";

    private ElementReference editorElement;
    private IJSObjectReference? module;
    private DotNetObjectReference<QuillEditor>? dotNetReference;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/quill-wrapper.js");
            dotNetReference = DotNetObjectReference.Create(this);

            await module.InvokeVoidAsync("initializeQuill", EditorId, dotNetReference, Placeholder ?? "", Height, Value ?? "");
        }
    }

    public async Task<string> GetValueAsync()
    {
        if (module != null)
        {
            return await module.InvokeAsync<string>("getQuillContent", EditorId);
        }
        return string.Empty;
    }

    public async Task SetValueAsync(string html)
    {
        if (module != null)
        {
            await module.InvokeVoidAsync("setQuillContent", EditorId, html);
        }
    }

    [JSInvokable]
    public async Task OnContentChanged(string html)
    {
        Value = html;
        await ValueChanged.InvokeAsync(html);
    }

    public async ValueTask DisposeAsync()
    {
        if (module != null)
        {
            try
            {
                await module.InvokeVoidAsync("destroyQuill", EditorId);
            }
            catch { }

            await module.DisposeAsync();
        }

        dotNetReference?.Dispose();
    }
}
